pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
-- battle snake
-- by mykalcodes

game = {
 state="start",
 upd=nil,
 drw=nil,
 last_tick=time(),
 tick_interval=0.15,
}

function _init()
	menu_init()
end

function _update()
 game:upd()
end

function _draw()
 game:drw()
end
-->8
-- main menu screen
function menu_init()
	game.upd=menu_update
	game.drw=menu_draw
end

function menu_update()
  if(btnp(❎)) then
  	sfx(0)
  	game_init()
  end
end

function menu_draw()
	cls(0)
 print("battle snake", 40, 56, 15)
 print("press ❎ to start", 32, 64, 15)
end

-->8
-- game screen
function game_init()
	player_init()
	game.upd=game_update
	game.drw=game_draw
	music(0,0,1)
end

function game_update()
 player_update()
 gs_update()
end

function game_draw()
	if time() - game.last_tick > game.tick_interval then
	 cls(0)
	 map(0,0,0)
	 player_draw()
	 gs_draw()
	 game.last_tick = time()
	end
end

-->8
-- game over screen
function game_over_init()
	music(-1,100)
	game.upd=game_over_update
	game.drw=game_over_draw
end

function game_over_update()
 if(btnp(❎)) then
  game_init()
 end
end

function game_over_draw()
	print("game over", 24, 58, 0)
	print("press ❎ to restart", 24, 64, 0)
end
-->8
-- player manager
player={}

function player_init()
	player.dir="left"
	player.pieces={
		{type="head", x=48, y=64, dir="left"},
		{type="body", x=56, y=64, dir="left"},
		{type="tail", x=64, y=64, dir="left"},
	}
	player.length=3
	player.head=player.pieces[1]
	player.tail=player.pieces[3]
	player.grow=function(self)
	 local tail = self.tail
		new_piece = {
		 type="tail",
		 x=tail.x,
		 y=tail.y,
		 dir=tail.dir,
		 cooldown=1  
		}
		self.tail.type="body"
		self.length+=1
		add(self.pieces, new_piece)
		self.tail = self.pieces[self.length]
	end
end

function player_update()
	local head = player.pieces[1]
	-- handle inputs
	if(btnp(⬆️)) then 
	 head.dir = "up"
	elseif(btnp(⬇️)) then
	 head.dir = "down"
	elseif(btnp(⬅️)) then
		head.dir = "left"
	elseif(btnp(➡️)) then
	 head.dir = "right"
	end
	if(btnp(❎)) then
		player:grow()
	end
	-- update position in 8x8 blocks
	-- for each tick
	if time() - game.last_tick > game.tick_interval then
		for piece in all(player.pieces) do
			local dir = piece.dir
			local cooldown = piece.cooldown
			if cooldown != nil and cooldown > 0 then
				piece.cooldown -= 1
			else 
				if dir == "up" then
				 piece.y -= 8
				elseif dir == "down" then
				 piece.y += 8
				elseif dir == "right" then
				 piece.x += 8 
				elseif dir == "left"  then
				 piece.x -= 8
				end
				-- check collisions
				if piece.x == player.head.x
				and piece.y == player.head.y 
				and piece != player.head then
				 sfx(2)
				 game_over_init()
				end
			end
		end
		-- cascade changes down the body
	 for i = count(player.pieces),1,-1 do
	  local cur = player.pieces[i]
	  local nxt = player.pieces[i-1]
	  if nxt != nil and cur.type != "head" then
	   cur.dir = nxt.dir
	  end
	 end
	end
	-- check colisions? maybe
end

function player_draw()
	for piece in all(player.pieces) do
	 local dir = piece.dir
	 local cooldown = piece.cooldown
	 local x_flip = dir == "right" and true or false
	 local y_flip = dir == "down" and true or false 
	 if(piece.type=="head") then
	  if dir == "right" or dir == "left" then
	   spr(1, piece.x, piece.y,1,1,x_flip,y_flip)
	  else 
	   spr(4, piece.x, piece.y,1,1,x_flip,y_flip)
	  end
	 elseif(piece.type=="body") then 
	  if dir == "right" or dir == "left" then
	   spr(2, piece.x, piece.y,1,1,x_flip,y_flip)
	  else 
	   spr(5, piece.x, piece.y,1,1,x_flip,y_flip)
	  end
	 else
	 	if dir == "right" or dir == "left" then
	   spr(3, piece.x, piece.y,1,1,x_flip,y_flip)
	  else 
	   spr(6, piece.x, piece.y,1,1,x_flip,y_flip)
	  end
	 end
	end
end
-->8
-- game state manager
state={}
apple={
	x=(flr(rnd(16)))*8,
	y=(flr(rnd(16)))*8,
}

function gs_update()
 -- check for apple collision
 if player.head.x == apple.x 
 and player.head.y == apple.y then
  new_x = (flr(rnd(16)))*8
  new_y = (flr(rnd(16)))*8
  apple.x = new_x
  apple.y = new_y
  game.tick_interval-=0.001
  sfx(1)
  player:grow()
 end
 
end

function gs_draw()
	spr(7,apple.x,apple.y)
end
__gfx__
00000000000099909999999900000000000008009999999909999990000004000000000000000000000000000000000000000000000000000000000000000000
00000000000997999999999999900000000080009999999909999990000040000000000000000000000000000000000000000000000000000000000000000000
00700700809999999999999999999900009999009999999909999990008888000000000000000000000000000000000000000000000000000000000000000000
00077000089999999999999999999999099999909999999900999900088888800000000000000000000000000000000000000000000000000000000000000000
00077000009999999999999999999999999999999999999900999900088888800000000000000000000000000000000000000000000000000000000000000000
00700700009999999999999999999900979999799999999900999900088888800000000000000000000000000000000000000000000000000000000000000000
00000000000997999999999999900000999999999999999900099000008888000000000000000000000000000000000000000000000000000000000000000000
00000000000099909999999900000000099999909999999900099000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333333333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333383333333334333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000033c333333333333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000003333333333c3333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333333333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000033b333d333333c3333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000003b333333333333c333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333333333333333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1213131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131213131113131313121300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313111313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313121113131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313111313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131211131313121300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1311131313131313121312131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313121313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1311131313131313131313131113131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131312131311131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131312131313131213131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131113131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131311131313111300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1113131213131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131311131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000400002005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000400002e7502b0302702022710270202b0302e7503f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100000247501f7501b75018750137500c7500775007700057000570005700000000570000000057000000001700037000000000000000000000000000000000000000000000000000000000000000000000000
001000100c0000c0433f215000000c04300000247533f2150c0430f3433f2000f3420c043000001c7533f20000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
03 03424344

